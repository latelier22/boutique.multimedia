name: Deploy Sylius to VPS

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H vps.latelier22.fr >> ~/.ssh/known_hosts

      # 1) Wipe and recreate both cache & log dirs as www-data
      - name: Prepare cache & logs on VPS
        run: |
          ssh -i ~/.ssh/id_rsa debian@vps.latelier22.fr << 'EOF'
            sudo rm -rf /var/www/boutique.multimedia/var/cache \
                         /var/www/boutique.multimedia/var/log
            sudo mkdir -p /var/www/boutique.multimedia/var/{cache,log}
            sudo chown -R www-data:www-data /var/www/boutique.multimedia/var
            sudo chmod -R 775 /var/www/boutique.multimedia/var
          EOF

      # 2) Clean built assets
      - name: Clean public/build on VPS
        run: |
          ssh -i ~/.ssh/id_rsa debian@vps.latelier22.fr \
            "sudo rm -rf /var/www/boutique.multimedia/public/build"

      # 3) Rsync your codeâ€”but exclude var/, vendor/, node_modules/, media/
      - name: Sync application code
        run: |
          rsync -az \
            --exclude 'vendor/' \
            --exclude 'node_modules/' \
            --exclude 'public/media/' \
            --exclude 'var/' \
            --delete \
            ./ debian@vps.latelier22.fr:/var/www/boutique.multimedia

      # 4) Install PHP deps *as root* so cache scripts can run
      - name: Install PHP dependencies
        run: |
          ssh -i ~/.ssh/id_rsa debian@vps.latelier22.fr << 'EOF'
            cd /var/www/boutique.multimedia
            sudo composer install --no-dev --optimize-autoloader
            # after install, ensure var is still owned by www-data
            sudo chown -R www-data:www-data var
            sudo chmod -R 775 var
          EOF

      # 5) Build front-end assets
      - name: Install Node deps & build assets
        run: |
          ssh -i ~/.ssh/id_rsa debian@vps.latelier22.fr << 'EOF'
            cd /var/www/boutique.multimedia
            sudo pnpm install
            sudo pnpm run build
          EOF

      # 6) Swap in .env and fix media perms
      - name: Env & media permissions
        run: |
          ssh -i ~/.ssh/id_rsa debian@vps.latelier22.fr << 'EOF'
            cd /var/www/boutique.multimedia
            cp .env.prod .env
            echo "GOOGLE_CSE_ID="${{ secrets.GOOGLE_CSE_ID }}" >> .env
            echo "GOOGLE_API_KEY="${{ secrets.GOOGLE_API_KEY }}" >> .env
            sudo chown -R www-data:www-data public/media
            sudo chmod -R 775 public/media
          EOF

      # 7) Restart services
      - name: Restart PHP-FPM & Nginx
        run: |
          ssh -i ~/.ssh/id_rsa debian@vps.latelier22.fr \
            "sudo systemctl restart php8.2-fpm && sudo systemctl restart nginx"

      - name: âœ… Done
        run: echo "ðŸŽ‰ Deployment complete!"
