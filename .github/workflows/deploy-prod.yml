name: Deploy Sylius to VPS

on:
  push:
    branches:
      - prod

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Load SSH key into ssh-agent
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
          known-hosts: vps.latelier22.fr

      # 1) Wipe and recreate cache & log dirs on the server
      - name: Prepare var/cache & var/log
        run: |
          ssh debian@vps.latelier22.fr << 'EOF'
            sudo rm -rf /var/www/boutique.multimedia/var/cache \
                         /var/www/boutique.multimedia/var/log
            sudo mkdir -p /var/www/boutique.multimedia/var/{cache,log}
            sudo chown -R www-data:www-data /var/www/boutique.multimedia/var
            sudo chmod -R 775 /var/www/boutique.multimedia/var
          EOF

      # 2) Remove old built assets
      - name: Clean public/build
        run: |
          ssh debian@vps.latelier22.fr \
            "sudo rm -rf /var/www/boutique.multimedia/public/build"

      # 3) Rsync code (excluding var/, vendor/, node_modules/, public/media/)
      - name: Sync application code
        run: |
          rsync -az \
            --exclude='vendor/' \
            --exclude='node_modules/' \
            --exclude='public/media/' \
            --exclude='var/' \
            --delete \
            ./ debian@vps.latelier22.fr:/var/www/boutique.multimedia

      # 4) Install PHP deps as root (so Symfony can clear/warm cache)
      - name: Install PHP dependencies
        run: |
          ssh debian@vps.latelier22.fr << 'EOF'
            cd /var/www/boutique.multimedia
            sudo composer install --no-dev --optimize-autoloader
            # Symfonyâ€™s post-install will clear/warm cache under www-data
            sudo chown -R www-data:www-data var
            sudo chmod -R 775 var
          EOF

      # 5) Build front-end assets
      - name: Install Node deps & build assets
        run: |
          ssh debian@vps.latelier22.fr << 'EOF'
            cd /var/www/boutique.multimedia
            sudo pnpm install
            sudo pnpm run build
          EOF

      # 6) Swap in prod .env and fix media permissions
      - name: Env file & media perms
        run: |
          ssh debian@vps.latelier22.fr << 'EOF'
            cd /var/www/boutique.multimedia
            cp .env.prod .env
            echo "GOOGLE_CSE_ID=${{ secrets.GOOGLE_CSE_ID }}" >> .env
            echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> .env
            sudo chown -R www-data:www-data public/media
            sudo chmod -R 775 public/media
          EOF

      # 7) Restart PHP-FPM & Nginx
      - name: Restart services
        run: |
          ssh debian@vps.latelier22.fr \
            "sudo systemctl restart php8.2-fpm && sudo systemctl restart nginx"

      - name: âœ… Deployment complete
        run: echo "ðŸŽ‰ Deployed to prod!"
